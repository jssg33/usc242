<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FusionCommerce – Payment Summary</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script type="module" src="https://esm.run/@material/web/all.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <link rel="stylesheet" href="./css/fusioncart.css" />
  <!-- Your new JS files -->
  <script src="./js/products.js"></script>
  <script src="./js/cart.js"></script>

  <style>
    /* NEW FIX: Keep menu button + FusionCommerce name on same line */
    .nav-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .nav-left .logo {
      white-space: nowrap;
      font-size: 18px;
      font-weight: 600;
      color: white;
    }
  </style>

  <script src="./js/products.js"></script>
  <script src="./js/cart.js"></script>
</head>

<body onload="
  loadCompanyDetails();
  loadProductSummary();
  loadCartMaster();
  checkpll();
  checkUserStatus();
  displayProfilePicture();
">

  <!-- NAVIGATION BAR -->
  <div class="navbar">
    <div class="nav-left">

      <div class="dropdown">
        <button class="jsmenu"><img src="./images/greenmenu5.png"></button>
        <div class="dropdown-content">
          <a href="../index.html">Home</a>
            <a href="../login.html">Login</a>
            <a href="../logout.html">Logout</a>
            <a href="../welcome.html">Welcome</a>
            <a href="../licenses.html">Licenses</a>
            <a href="../deployments.html">Deployments</a>
            <a href="../reviews.html">AllReviews</a>
            <a href="../mylicenselogs.html">MyLicenseLogs</a>
            <a href="../mylicenses.html">MyLicenses</a>
            <a href="../pricing/wizard.html">PricingWizard</a>
            <a href="../mycart.html?uid=1">MyCart</a>
            <a href="../myprofile.html">MyProfile</a>
            <a href="../testimonials.html">AdminTestimonials</a>
            <a href="../products.html">AdminProducts</a>
            <a href="../licensetypes.html">AdminLicenseTypes</a>
            <a href="../template.html">AdminPageTemplate</a>
        </div>
      </div>

      <div class="logo">FusionCommerce – Product Review</div>

    </div>

    <div class="nav-right">
      <img src="./images/blackcircle.png" id="profilephototarget" alt="User" onclick="window.location.href='myprofile.html'" />
      <span id="H3UserBanner"></span>

      <div class="right-links" style="display:flex; gap:6px; align-items:center; color: white;">
        <md-text-button class="icon-only" href="index.html"><span class="material-icons" style="color:white;">home</span></md-text-button>
        <md-text-button class="icon-only" href="userhelp.html"><span class="material-icons" style="color:white;">help_outline</span></md-text-button>
        <md-text-button class="icon-only" href="usernotices.html"><span class="material-icons" style="color:white;">notifications</span></md-text-button>
        <md-text-button class="icon-only" href="login.html"><span class="material-icons" style="color:white;">login</span></md-text-button>
        <md-text-button class="icon-only" href="logout.html"><span class="material-icons" style="color:white;">logout</span></md-text-button>
        <md-text-button class="icon-only" href="myprofile.html"><span class="material-icons" style="color:white;">person</span></md-text-button>
        <md-text-button class="icon-only" href="mycart.html"><span class="material-icons" style="color:white;">shopping_cart</span></md-text-button>
      </div>
    </div>
  </div>

  <div class="container mt-4">
    <h2>Payment Summary</h2>

    <div id="summary" class="mb-3"></div>

    <div class="accordion" id="cartAccordion"></div>

    <div id="status" class="mt-3"></div>
  </div>

  <!-- ========================= -->
  <!-- UPDATED SCRIPT -->
  <!-- ========================= -->
  <script>
    const API = "https://api242.onrender.com";
    const params = new URLSearchParams(window.location.search);
    const cartIds = params.getAll("cartId");
    const uid = localStorage.getItem("uid") || "1";

    async function loadCartData() {
      let allItems = [];
      let cartSummaries = [];

      for (const cartId of cartIds) {
        const res = await fetch(`${API}/cartitems/cart/${cartId}`);
        const items = await res.json();

        const total = items.reduce((sum, i) => sum + (i.itemtotals || 0), 0);

        cartSummaries.push({ cartId, total, items });
        allItems.push(...items);
      }

      const grandTotal = cartSummaries.reduce((sum, c) => sum + c.total, 0);
      const totalItems = allItems.length;

      document.getElementById("summary").innerHTML = `
        <p><strong>Total Amount:</strong> $${grandTotal.toFixed(2)}</p>
        <p><strong>Total Carts:</strong> ${cartSummaries.length}</p>
        <p><strong>Total Items:</strong> ${totalItems}</p>

        <button class="btn btn-success btn-lg mt-3"
          onclick='goPayNow(${grandTotal}, ${JSON.stringify(cartSummaries)})'>
          Pay Now ($${grandTotal.toFixed(2)})
        </button>
      `;

      renderAccordion(cartSummaries);
    }

    function renderAccordion(carts) {
      const acc = document.getElementById("cartAccordion");
      acc.innerHTML = "";

      carts.forEach((c, index) => {
        let rows = c.items.map(i => `
          <tr>
            <td>${i.itemDescription || i.itemType}</td>
            <td>${i.itemqty || 1}</td>
            <td>$${(i.itemtotals || 0).toFixed(2)}</td>
          </tr>
        `).join("");

        acc.innerHTML += `
          <div class="accordion-item">
            <h2 class="accordion-header" id="heading${index}">
              <button class="accordion-button collapsed" type="button"
                data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                Cart ${c.cartId} — $${c.total.toFixed(2)}
              </button>
            </h2>
            <div id="collapse${index}" class="accordion-collapse collapse"
              data-bs-parent="#cartAccordion">
              <div class="accordion-body">
                <table class="table table-sm table-bordered">
                  <thead>
                    <tr><th>Item</th><th>Qty</th><th>Total</th></tr>
                  </thead>
                  <tbody>${rows}</tbody>
                </table>
              </div>
            </div>
          </div>
        `;
      });
    }

    function goPayNow(totalAmount, cartSummaries) {
      const uid = localStorage.getItem("uid") || "1";
      const cartIds = cartSummaries.map(c => c.cartId).join(",");

      const url =
        `paynow2.html` +
        `?uid=${uid}` +
        `&amount=${totalAmount.toFixed(2)}` +
        `&cartIds=${cartIds}`;

      window.location.href = url;
    }

    loadCartData();
  </script>

  <footer class="footer">
    &copy; Greenville Associates Consulting, Inc.<br>
    All rights reserved.<br>
    <a href="sitemap.html" class="sitelink">SiteMap</a>
  </footer>

</body>
</html>
