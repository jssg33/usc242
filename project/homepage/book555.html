<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="./css/login.css" />
  <link rel="stylesheet" href="./css/dropmenu.css" />
  <script src="./js/bikes.js"></script>
  <title>Mountain Bike Parks</title>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<style>
#userGreeting
{
text-align: center;
vertical-align: middle;
color: yellow;
}
#banner
{
background-color: lightgrey;
height: 60px;
vertical-align: middle;
width: 100%;
}


* { box-sizing: border-box; }

.columnproducts { float: left; width: 30%; padding: 10px; height: 450px; }
.columnselected { float: left; width: 52%; padding: 10px; height: 450px; }
.columnactions { float: left; width: 13%; padding: 10px; height: 450px; background-color: blue; font: white; text-align: center; margin: 0 auto; }
.column3 { float: left; width: 15%; padding: 10px; height: 300px; }
.parkinfo { float: left; width: 49%; padding: 10px; height: 500px; overflow-y: auto;}
.cartinfo { float: left; width: 49%; padding: 10px; height: 500px; overflow-y: auto;}

#productstuff { background-color: #aaa; height: 640px; width: 95%; }
#interiorpanel { margin-left: 50px; height: 150px; width: 95%;   margin-bottom: 5px;
  padding-bottom: 5px;}

#salesgrid
{
  margin-bottom: 5px;
  padding-bottom: 5px;
  float: left;
  margin-left: 50px;
  width: 95%;
  height: 450px;
}  

button { width: 150px; height: 60px; }

.row:after { content: ""; display: table; clear: both; height: 10px; }
.row2:after { content: ""; display: table; clear: both; height: 10px; }

body { font-family: Arial, sans-serif; padding: 20px; }
h1 { text-align: center; }
.container { width: 1500px; }
  
#catalogue { min-width: 80%; max-width: 30%; font-size: 9pt; height: 300px; }
#someselected { min-width: 80%; max-width: 450px; font-size: 9pt;  height: 300px;}

#selected {
  width: 450px;
  border-collapse: collapse;
  font-size: 0.9rem;
}

#selected th, 
#selected td {
  border: 1px solid #999;
  padding: 6px 10px;
  text-align: left;
}

#selected th {
  background-color: #e0e0e0;
  font-weight: bold;
  width: 80px;
}

#selected tbody tr:nth-child(even) {
  background-color: #f9f9f9;
}

/* Column widths */
#selected th:nth-child(1),
#selected td:nth-child(1) {
  width: 35%;   /* Item column */
}

#selected th:nth-child(2),
#selected td:nth-child(2) {
  width: 15%;   /* Price column */
}

#selected th:nth-child(3),
#selected td:nth-child(3),
#selected th:nth-child(4),
#selected td:nth-child(4) {
  width: 10%;   /* Adults & Children columns */
  text-align: center;
}
/* Master container spans full width */
/* Master container spans full width and centers content */
.master-row {
  display: flex;
  /*justify-content: center;   center horizontally */
  /*align-items: flex-start;   align at the top */
  gap: 30px;                 /* space between date block and radios */
  width: 95%;
  margin: 20px auto;         /* center with margin */
  box-sizing: border-box;
  float: left;
  background-color: #75BFEC;
}

/* Date block styling */
.date-block {
  display: flex;
  gap: 15px;
  align-items: center;
}

/* Interests block styling */
.interests-block {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  font-size: 0.8rem;          /* smaller print */
}

#park-details
{
font-size: 10pt;
margin-top: 3px;
margin-bottom: 3px;
left:20px;
}

 /* Modal background */
    #reservationModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }

    /* Modal box */
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 450px;
      text-align: center;
      background-color: peachpuff;
    }

    /* Modal inputs (full width for usability) */
    .modal-content input {
      width: 80%;
      padding: 6px;
      margin-top: 8px;
    }

    /* Result window fields (your request: 50px wide) */
    .result-field {
      width: 150px;
      padding: 4px;
    }

    button {
      margin-top: 15px;
      padding: 8px 16px;
    }

#modalStartDate
  {
  width: 190px;
  }
#modalEndDate
  {
  width: 190px;
  }

  
 .number-row {
  width: 100%;
  overflow: hidden; /* keeps the row height correct */
  margin-bottom: 8px;
}

.number-row label,
.number-row input,
.number-row button {
  float: left;
  margin-right: 6px;
}

#leftblock input[type="date"],
#leftblock input[type="number"] {
  border: 1px solid #ccc;   /* or your preferred border */
  outline: none;
  box-shadow: none;
}

#reservationModal button {
  width: 30px;
  height: 30px;
  padding: 0;
  margin: 2px;
  font-size: 16px;
  line-height: 30px;
  text-align: center;
  display: inline-block;
}

/* Make modal inputs consistent */
#reservationModal input[type="number"],
#reservationModal input[type="date"] {
  width: 100px;          /* ✅ fixed width */
  height: 28px;
  font-size: 14px;
  padding: 2px 4px;
  box-sizing: border-box;
}

/* Make + / – buttons small and neat */
#reservationModal .number-row button {
  width: 28px;
  height: 28px;
  padding: 0;
  margin-left: 4px;
  font-size: 18px;
  line-height: 28px;
  text-align: center;
}

/* Left-align the number rows */
#reservationModal .number-row {
  width: 100%;
  overflow: hidden;
  margin-bottom: 10px;
}

#reservationModal .number-row label,
#reservationModal .number-row input,
#reservationModal .number-row button {
  float: left;
  margin-right: 6px;
}

/* --- MASTER LAYOUT --- */
.master-row {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: flex-start;
  gap: 20px;
  width: 95%
  margin-bottom: 5px;
  padding-bottom: 5px;
  max-height: 100px;
}

/* --- LEFT COLUMN --- */
.left-column {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 20px;
  border-bottom: none;  
  margin-top: 5px !important;
  margin-bottom: 5px !important;
}

.date-block,
.shell-block {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 10px;
}

/* --- RIGHT COLUMN --- */
.right-column {
  display: flex;
  flex-direction: row;   /* puts h5 and interests on same line */
  align-items: center;
  gap: 20px;
  flex-wrap: nowrap;
  margin-top: 5px !important;
  margin-bottom: 5px !important;
}

/* --- INTERESTS BLOCK --- */
.interests-block {
  display: flex;
  flex-direction: row;
  flex-wrap: nowrap;     /* keeps all checkboxes on one line */
  gap: 15px;
  align-items: center;
}



</style>
</head>
<body onload="openReservationModal(); checkpll(); checkUserStatus(); displayProfilePicture(); loadParkSummary();">
  <!-- Navigation Bar -->
  <div class="navbar">
    <div class="nav-left">
      <div class="dropdown">
        <button class="jsmenu"><img src="./images/jsmenu4.png"></button> 
        <div class="dropdown-content">
            <a href="login.html">Login</a>
            <a href="logout.html">Logout</a>
            <a href="welcome.html">Welcome</a>
            <a href="products.html">All Products</a>
            <a href="licensetypes.html">LicenseTypes</a>
            <a href="mylicenselogs.html">LicenseLogs</a>
            <a href="mylicenses.html">MyLicenses</a>
            <a href="mycart.html">MyCart</a>
            <a href="reviews.html">AllReviews</a>
            <a href="Help.html">Help</a>
        </div>
      </div> 
      <div class="logo">&nbsp;&nbsp;MyLinkv25 - Review Parks</div>
    </div>
    <div class="nav-right">
      <img src="./images/bluecircle.png" id="profilephototarget" alt="User" style="cursor:pointer;" onclick="window.location.href='profile.html'" />
      <span id="H3UserBanner"></span>
      <a href="login.html" id="loginBtn" class="btn secondary-btn" onclick="loginUser(event)">Login</a>
      <a href="login.html" id="logoutBtn" class="btn secondary-btn" onclick="logoutUser(event)">Logout</a>
              <a href="cartreview.html" id="cartBtn3"><img src="./images/cart4.png" width="40px" height="40px"></a>
    </div>
  </div>

  <div align="center" id="banner"><span id="userGreeting">Welcome Guest</span></div><BR><BR>


 <div class="row2">
   <div class="parkinfo" style="background-color:#aaa;">
     <h3>ParkInfo</h3>
     <hr>
     <div style="display: flex; align-items: center; gap: 10px;">
  <span><strong>Current Park ID:</strong> <span id="currentParkId"></span><span id="currentParkName"></span></span>&nbsp&nbsp&nbsp&nbsp
&nbsp&nbsp
  <label for="parkSelector">Change Park:</label>
  <select id="parkSelector" onchange="changePark()" 
          style="max-width: 200px; font-size: 0.85rem; padding: 2px 8px;">
    <option value="">Select a Park</option>
  </select>
  </div><HR>
<div id="park-details"></div>
   </div>

   <div class="cartinfo" style="background-color: #D3D3D3;">
     <h3>User Actions History</h3>
     <hr>
     <div id="cartMasterCard" style="border:1px solid #999; background-color:#eee; max-height:320px; overflow-y:auto; display:none;">
       <div style="background-color:#ccc; padding:5px; text-align:center;">
         Your Cart Master Summary For User: <span id="masterowner"></span>
       </div>
       <div style="padding:10px;">
         <p>
           Loyalty ID: <span id="loyaltyid"></span><br>
           Carts Count: <span id="cmCartsCount"></span><br>
           Active Carts: <span id="cmCartsActive"></span><br>
           Cancelled Carts: <span id="cmCartsCancelled"></span><br>
           Active List: <span id="cmCartsActiveList" style="max-height:100px;"></span>
         </p>
         <br>
         <div>
           <button id="newcartbutton" onclick="createNewCart()">Add New Cart</button>
         </div>
       </div>
     </div>
   </div>
 </div>

 <hr>

 <div id="productstuff">
   <div id="interiorpanel">
     <h4>Reservation Details</h4>
        <div class="master-row">

              <!-- LEFT COLUMN -->
              <div class="left-column">
              <h5 style="color: blue;">Reservation Basics</h5>

              <div class="date-block">
                <label for="globalStartDate" style="font-size: 8pt;">Start:</label>
                <input type="date" id="globalStartDate">

                <label for="globalEndDate" style="font-size: 8pt;">End:</label>
                <input type="date" id="globalEndDate">
              </div>

            <div class="shell-block">
              <label for="globalAdults" style="font-size: 8pt;">Adults:</label>
              <input type="number" id="globalAdults" style="width: 50px;">

              <label for="globalChildren" style="margin-left: 10px; font-size: 8pt;">Children:</label>
              <input type="number" id="globalChildren" style="width: 50px;">

              <label for="globalTentSites" style="margin-left: 10px; font-size: 8pt;">TentSites:</label>
              <input type="number" id="globalTentSites" style="width: 50px;">
            </div>
            </div>

  <!-- RIGHT COLUMN -->
  <div class="right-column">
    <h5 style="color: blue;">Interests:</h5>

    <div class="interests-block">
      <label><input type="checkbox" name="activities" value="dirtbikes"> Dirtbikes</label>
      <label><input type="checkbox" name="activities" value="mountain_biking" checked> Mountain Biking</label>
      <label><input type="checkbox" name="activities" value="tentcamping"> Tent Camping</label>
      <label><input type="checkbox" name="activities" value="cabins"> Cabins</label>
      <label><input type="checkbox" name="activities" value="skiing"> Skiing</label>
      <label><input type="checkbox" name="activities" value="rafting"> Rafting</label>
      <label><input type="checkbox" name="activities" value="other"> Other Actions</label>
    </div>
  </div>
</div>
</div>
     <div class="row" id="salesgrid">
       <div class="columnproducts" style="background-color:#D3D3D3;">
         <h3>Products</h3>
         <hr>
         <select id="catalogue" multiple style="width: 90%; margin-left: 20px;"></select>
       </div>
       <div class="columnactions" style="background-color: #D3D3D3;">
         <h3>Actions</h3><hr>
         <button onclick="moveToSelected()">Add Item(s)</button><br><br>
         <button onclick="moveToCatalogue()">Remove Item(s)</button><br><br>
         <button onclick="addSelectedToCart()">Save Item(s)</button><br>
       </div>
        <div class="columnselected" style="background-color: #D3D3D3;">
         <h3>Selected</h3>
         <hr>
         <table id="selected">
          <thead>
          <tr>
          <th style="width:160px;">Description</th>
          <th style="width:90px;">Price</th>
          <th style="width:60px;">Adults</th>
          <th style="width:60px;">Children</th>
          <th style="width:90px;">Subtotal</th>
          <th style="width:90px;">State Tax (6%)</th>
          <th style="width:90px;">Local Tax (1.5%)</th>
          <th style="width:60px;">Line Total</th>
          </tr>
          </thead>
          <tbody></tbody>
          </table>
       </div>
      
     </div>
   </div>

 <hr>

<!-- Modal -->
<div id="reservationModal">
  <div class="modal-content">
    <h3>Reservation Basics</h3>
  <div class="number-row"><label>Adults:&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp</label> <input type="number" id="modalAdults" value="1" > <button type="button" onclick="dec('modalAdults')">−</button><button type="button" onclick="inc('modalAdults')">+</button></div>
<br>
<div class="number-row">
  <label>Children:&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp</label><input type="number" id="modalChildren" value="0" ><button type="button" onclick="dec('modalChildren')">−</button><button type="button" onclick="inc('modalChildren')">+</button></div>
<br>

<div class="number-row"><label>Tent Sites:&nbsp&nbsp&nbsp&nbsp</label><input type="number" id="modalTentSites" value="0"><button type="button" onclick="dec('modalTentSites')">−</button><button type="button" onclick="inc('modalTentSites')">+</button></div>
<br>

    <div style="font-size: 8pt;"><label id="startdate" style="float: left;font-size: 8pt;">Start Date:<input type="date" id="modalStartDate"></label>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp<label id="enddate" style="float:  left;font-size: 8pt;">End Date:&nbsp&nbsp&nbsp<input type="date" id="modalEndDate"></label></div>
    <br><br>
    <button onclick="submitModalDetails()" style="width: 100px;">Submit</button>
    <button onclick="closeReservationModal()" style="width: 100px; margin-left: 10px;">Close</button>
  </div>
</div>



<!-- ================== SCRIPT PART 1: Globals & Utilities ================== -->
<script>
const baseUrl = "https://parksapi-h8btdjefb3gpdxaf.westus3-01.azurewebsites.net";
const cardApi = `${baseUrl}/api/Card`;
const paymentApi = `${baseUrl}/api/Payments`;
const cartApi = `${baseUrl}/api/Cart`;
const API_ROOT = 'https://parksapi-h8btdjefb3gpdxaf.westus3-01.azurewebsites.net';
const uid = localStorage.getItem('uid');
const urlParams = new URLSearchParams(window.location.search);
let parkId = parseInt(urlParams.get('parkId')) || 0;
let cartId = null;
let catalogueItems = [];
let someparkid = parkId;
let someparkname = "somepark";

async function LoadNewCart() {
    if (!uid) {
      alert("No UID found in localStorage. Please log in.");
      return;
    }

    await ensureCartMasterExists();
    await displayCartMaster();
    await createNewCart(); //MOVING NEW CART CREATION TO WAIT UNTIL ITEMS SELECTED.
    await loadCatalogue();
    await loadParksDropdown();
    await loadParkSummary();
  }


  
function setDates() {
  const today = new Date().toISOString().split('T')[0]; // Format: YYYY-MM-DD
  document.getElementById('globalStartDate').value = today;
  document.getElementById('globalEndDate').value = today;
}

function changeQty(id, delta) {
  const input = document.getElementById(id);
  let value = parseInt(input.value, 10) || 0;
  value = Math.max(0, value + delta);
  input.value = value;
}

 

<!-- ================== SCRIPT PART 2: Cart Master & Park Functions ================== -->

// --- Cart Master Functions ---
async function ensureCartMasterExists() {
  const uid = localStorage.getItem('id');
  const response = await fetch(`${API_ROOT}/api/CartMaster/user/${uid}`);
  const masters = await response.json();

  if (masters.length === 0) {
    const newMaster = {
      userId: uid,
      cartsCount: 0,
      cartsCancelled: 0,
      cartsActive: 0,
      cartsActiveList: ""
    };

    await fetch(`${API_ROOT}/api/CartMaster`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(newMaster)
    });
  }
}

async function displayCartMaster() {
  const uid = localStorage.getItem('id');
  const response = await fetch(`${API_ROOT}/api/CartMaster/user/${uid}`);
  const masters = await response.json();

  if (masters.length > 0) {
    const master = masters[0];
    document.getElementById('cmCartsCount').textContent = master.cartsCount;
    document.getElementById('cmCartsActive').textContent = master.cartsActive;
    document.getElementById('cmCartsCancelled').textContent = master.cartsCancelled;
    document.getElementById('cmCartsActiveList').textContent = master.cartsActiveList;
    document.getElementById('cartMasterCard').style.display = 'block';
    document.getElementById('masterowner').innerHTML = master.userId;
  }
}

async function createNewCart() {
  const uid = localStorage.getItem('id');
  const generatedCartId = Math.floor(Math.random() * 1000000);
  cartId = generatedCartId;

  // ✅ Pull values from your UI
  const startDate = document.getElementById("globalStartDate").value;
  const endDate   = document.getElementById("globalEndDate").value;

  const adults    = Number(document.getElementById("globalAdults").value) || 0;
  const children  = Number(document.getElementById("globalChildren").value) || 0;
  const tentsites = Number(document.getElementById("globalTentSites").value) || 0;

  const newCart = {
    cartId: generatedCartId,
    uid: uid,
    parkId: parkId,            // assumed defined elsewhere
    parkname: someparkname,    // assumed defined elsewhere
    itemType: "Combination",
    itemDescription: "2 Separate Products",
    quantity: 0,
    unitPrice: 0,
    totalPrice: 0,
    dateAdded: new Date().toISOString().split("T")[0],
    isCheckedOut: 0,
    paymentid: "",
    bookinginfo: "[33,34]",
    totalcartitems: 0,
    multipleitems: 0,
    johnstotals: 0,
    transactiontotal: 0,

    // ✅ These now come from your UI
    resStart: startDate,
    resEnd: endDate,
    adults: adults,
    children: children,
    tentsites: tentsites
  };

  try {
    const response = await fetch(`${API_ROOT}/api/Cart`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(newCart)
    });

    const text = await response.text();

    if (response.status !== 201) {
      console.error('Cart creation failed:', response.status);
      alert('Failed to create cart.');
      return;
    }

    let createdCart;
    try {
      createdCart = text ? JSON.parse(text) : {};
    } catch (err) {
      console.warn('Response body not valid JSON:', text);
      createdCart = {};
    }

    cartId = createdCart.cartId || generatedCartId;
    console.log('Cart created with ID:', cartId);

    // ✅ Update CartMaster
    const masterRes = await fetch(`${API_ROOT}/api/CartMaster/user/${uid}`);
    const masters = await masterRes.json();

    if (masters.length > 0) {
      const master = masters[0];
      const updatedList = master.cartsActiveList
        ? `${master.cartsActiveList},${cartId}`
        : `${cartId}`;

      const updatedMaster = {
        ...master,
        cartsCount: master.cartsCount + 1,
        cartsActive: master.cartsActive + 1,
        cartsActiveList: updatedList
      };

      await fetch(`${API_ROOT}/api/CartMaster/${master.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedMaster)
      });

      console.log('CartMaster updated with new cart:', updatedMaster);
      await displayCartMaster();
    }
  } catch (error) {
    console.error('Unexpected error during cart creation:', error);
    alert('An unexpected error occurred while creating the cart.');
  }
}

  
// --- Park Functions ---
async function loadParksDropdown() {
  const response = await fetch(`${API_ROOT}/api/Parks`);
  const parks = await response.json();

  const selector = document.getElementById('parkSelector');
  selector.innerHTML = '<option value="">Select a Park</option>';
  parks.forEach(park => {
    const option = document.createElement('option');
    option.value = park.parkId;
    option.textContent = `${park.name} (ID: ${park.parkId})`;
    selector.appendChild(option);
  });

  document.getElementById('currentParkId').textContent = parkId;
  const currentPark = parks.find(p => p.parkId === parkId);
  document.getElementById('currentParkName').textContent = currentPark ? currentPark.name : 'Unknown';
  someparkname = currentPark ? currentPark.name : "Unknown";
}

function changePark() {
  const newParkId = document.getElementById('parkSelector').value;
  if (!newParkId) return;

  const newUrl = new URL(window.location.href);
  newUrl.searchParams.set('parkId', newParkId);
  window.history.pushState({}, '', newUrl);

  parkId = parseInt(newParkId);
  document.getElementById('currentParkId').textContent = parkId;
  loadParkSummary();
  loadCatalogue();
}

async function loadParkSummary() {
  const parkDetails = document.getElementById("park-details");
  if (!parkId) {
    parkDetails.innerHTML = `<div class="alert alert-danger">No parkId provided in URL.</div>`;
    return;
  }

  $.ajax({
    url: `${API_ROOT}/api/Parks/${parkId}`,
    method: "GET",
    success: function (data) {
      const park = Array.isArray(data) ? data[0] : data;
      if (!park) {
        parkDetails.innerHTML = `<div class="alert alert-warning">No park found for ID ${parkId}.</div>`;
        return;
      }
      const trailMapLink = park.trailmapurl
        ? `<a href="${park.trailmapurl}" target="_blank">Trail Map</a>`
        : `<span class="text-muted">No trail map available</span>`;
      const mapsLink = `https://www.google.com/maps?q=${park.latitude},${park.longitude}`;
      const directionsLink = `https://www.google.com/maps/dir/?api=1&destination=${park.latitude},${park.longitude}`;
      const pictureurl = `https://home.547bikes.info/picturewall.html?parkId=${park.parkId}`;
      someparkname = park.name;
      someparkid = park.id;

      parkDetails.innerHTML = `
        <div>
          <h3>${park.name}</h3>
          <p><strong>Region:</strong> ${park.region}</p>
          <p><strong>Address:</strong> ${park.address}</p>
          <p><strong>Phone:</strong> ${park.phone}</p>
          <p><strong>Trail Length:</strong> ${park.trailLengthMiles} miles</p>
          <p><strong>Difficulty:</strong> ${park.difficulty}</p>
          <p><strong>Day Pass:</strong> $${typeof park.dayPassPriceUsd === "number" ? park.dayPassPriceUsd.toFixed(2) : "N/A"}</p>
          <p><strong>Description:</strong> ${park.description}</p>
          <p><strong>GPS:</strong> ${park.latitude}, ${park.longitude}</p>
          ${trailMapLink}<br>
          <a href="book5.html?parkId=${park.parkId}">Book This Park</a><br>
          <a href="${mapsLink}" target="_blank">Open in Google Maps</a>
          <a href="${directionsLink}" target="_blank">Get Driving Directions</a><br>
          <a href="reviews5.html?parkId=${park.parkId}" target="_blank">See Reviews</a>
          <a href="${pictureurl}" target="_blank">View Park Pictures</a>
        </div>
      `;
    },
    error: function (xhr, status, error) {
      console.error("❌ Error loading park:", status, error);
      parkDetails.innerHTML = `<div class="alert alert-danger">Error loading park details: ${error}</div>`;
    }
  });
}
<!-- ================== SCRIPT PART 3: Catalogue & Cart Item Functions ================== -->

// --- Catalogue Functions ---
async function loadCatalogue() {
  try {
    if (!parkId) throw new Error("Missing or invalid global parkId");

    const response = await fetch(`${API_ROOT}/api/SalesCatalogue`);
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

    const allItems = await response.json();
    catalogueItems = allItems.filter(item =>
      item.parkId === parkId || item.global === 1
    );

    catalogueItems.sort((a, b) => (a.description || '').localeCompare(b.description || ''));

    const catalogueSelect = document.getElementById('catalogue');
    catalogueSelect.innerHTML = '';

    catalogueItems.forEach(item => {
      const description = item.description || 'Unnamed Item';
      const price = typeof item.price === 'number' ? item.price : 0;
      const priceText = price > 0 ? `$${price.toFixed(2)}` : 'Free';

      const option = document.createElement('option');
      option.value = item.salesCatalogueId;
      option.text = `${description}, ${priceText}`;
      option.dataset.price = price.toFixed(2);
      option.dataset.vendor = item.serviceType || "Unknown";
      option.dataset.salescatid = item.salesCatalogueId;

      catalogueSelect.appendChild(option);
    });
  } catch (error) {
    console.error("❌ Failed to load catalogue:", error);
  }
}

function moveToSelected() {
  LoadNewCart();
  const catalogue = document.getElementById('catalogue');
  const selectedTable = document.getElementById('selected').querySelector('tbody');

  Array.from(catalogue.selectedOptions).forEach(option => {
    const description = option.text.split(',')[0];
    const price = parseFloat(option.dataset.price || '0.00');

    const row = document.createElement('tr');
    row.innerHTML = `
      <td style="width:160px;">${description}</td>
      <td style="width:90px;">$${price.toFixed(2)}</td>
      <td><input type="number" class="adults" value="1" min="0" style="width:60px;"></td>
      <td><input type="number" class="children" value="0" min="0" style="width:60px;"></td>
      <td class="subtotal" style="width:90px;">$0.00</td>
      <td class="state-tax" style="width:90px;">$0.00</td>
      <td class="local-tax" style="width:90px;">$0.00</td>
      <td class="line-total" style="width:90px;">$0.00</td>
    `;
    
    selectedTable.appendChild(row);
    catalogue.removeChild(option);

    // Function to recalc totals for this row
    function recalc() {
      const adults = parseInt(row.querySelector('.adults').value) || 0;
      const children = parseInt(row.querySelector('.children').value) || 0;
      const qty = adults + children;

      const subtotal = qty * price;
      const stateTax = subtotal * 0.06;
      const localTax = subtotal * 0.015;
      const lineTotal = subtotal + stateTax + localTax;

      row.querySelector('.subtotal').textContent = `$${subtotal.toFixed(2)}`;
      row.querySelector('.state-tax').textContent = `$${stateTax.toFixed(2)}`;
      row.querySelector('.local-tax').textContent = `$${localTax.toFixed(2)}`;
      row.querySelector('.line-total').textContent = `$${lineTotal.toFixed(2)}`;
    }

    // Initial calculation
    recalc();

    // Recalculate whenever quantities change
    row.querySelector('.adults').addEventListener('input', recalc);
    row.querySelector('.children').addEventListener('input', recalc);
  });
}


function moveToCatalogue() {
  const catalogue = document.getElementById('catalogue');
  const selectedTable = document.getElementById('selected').querySelector('tbody');

  Array.from(selectedTable.querySelectorAll('tr')).forEach(row => {
    const description = row.cells[0].textContent;
    const price = row.cells[1].textContent.replace('$', '');
    const option = document.createElement('option');
    option.text = `${description}, $${price}`;
    catalogue.appendChild(option);
    row.remove();
  });
}

function applyQuantities() {
  const adults = parseInt(document.getElementById('qty-adults').value) || 0;
  const children = parseInt(document.getElementById('qty-children').value) || 0;

  const rows = document.querySelectorAll('#selected tbody tr');
  rows.forEach(row => {
    row.querySelector('.adults').textContent = adults;
    row.querySelector('.children').textContent = children;
  });
}

async function addSelectedToCart() {
  const rows = document.querySelectorAll('#selected tbody tr');
  const urlParams = new URLSearchParams(window.location.search);
  const parkId = parseInt(urlParams.get("parkId")) || null;
  const shopId = parkId;
  const startDate = document.getElementById("globalStartDate").value;
  const endDate   = document.getElementById("globalEndDate").value;
  const someuser = localStorage.getItem("uid");

  if (!cartId) {
    alert('Cart has not been created yet. Please wait or try again.');
    console.error('Attempted to save CartItems without a valid cartId.');
    return;
  }

  if (rows.length === 0) {
    alert('Please select at least one item to add to cart.');
    return;
  }

  const parkName = document.getElementById('currentParkName')?.textContent.trim() || "Unknown Park";

  for (const row of rows) {
    const description = row.cells[0].textContent.trim();
    const price = parseFloat(row.cells[1].textContent.replace('$','')) || 0;

    // Adults/Children are inputs
    const adults = parseInt(row.querySelector('.adults').value) || 0;
    const children = parseInt(row.querySelector('.children').value) || 0;
    const qty = adults + children;

    if (isNaN(price) || price <= 0 || qty <= 0) {
      console.warn(`Invalid item:`, description);
      continue;
    }

    // Read calculated values from the table cells
    const subtotal = parseFloat(row.querySelector('.subtotal').textContent.replace('$','')) || 0;
    const stateTax = parseFloat(row.querySelector('.state-tax').textContent.replace('$','')) || 0;
    const localTax = parseFloat(row.querySelector('.local-tax').textContent.replace('$','')) || 0;
    const lineTotal = parseFloat(row.querySelector('.line-total').textContent.replace('$','')) || 0;

    // Proper date handling
    const now = new Date();
    const isoDate = now.toISOString();

    const cartItem = {
      cartid: cartId,
      cartitemdate: isoDate,
      itemvendor: "Unknown",
      itemdescription: description || "Unnamed Item",
      itemextendedprice: price.toFixed(2),
      itemqty: qty,
      adults,
      children,
      itemsubtotal: subtotal.toFixed(2),       // ✅ base subtotal
      statetaxtotal: stateTax.toFixed(2),      // ✅ state tax
      ustaxtotal: localTax.toFixed(2),         // ✅ local tax
      itemtotals: lineTotal,        // ✅ subtotal + taxes
      statetaxpercent: 6,
      statetaxauth: "SC",
      ustaxpercent: 1.5,
      salescatid: 0,
      productid: "0",
      shopid: shopId?.toString() || "0",
      parkid: parkId?.toString() || "0",
      created_date: isoDate,
      resStart: startDate,
      resEnd: endDate,
      qrcodeurl: "1",
      reservationcode: "1",
      memberid: "1",
      rewardsprovider: "Mariott",
      parkname: parkName,
      userid: parseInt(someuser) || 0
    };

    console.log('CartItem', cartItem);

    try {
      const response = await fetch("https://parksapi-h8btdjefb3gpdxaf.westus3-01.azurewebsites.net/api/CartItem", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(cartItem)
      });

      if (!response.ok) {
        const errorDetails = await response.text();
        throw new Error(`Server responded with ${response.status}:\n${errorDetails}`);
      }

      console.log("✅ Item saved successfully.");
    } catch (err) {
      console.error("❌ Error saving item:", err.message);
      alert("Failed to save item. Check console for details.");
    }
  }

  // After all items are processed
  try {
    await setCartTotals();
    const uid = localStorage.getItem("uid");
    const urlParams = new URLSearchParams(window.location.search);
    const parkId = urlParams.get("parkId");
    const cartUrl = `cart5.html?uid=${encodeURIComponent(uid)}&parkId=${encodeURIComponent(parkId)}`;
    window.open(cartUrl, '_self');
  } catch (err) {
    console.error("❌ Error updating cart totals:", err.message);
    alert("Failed to update cart totals.");
  }
}


async function updateCartTotals(currentcartId, currentparkId) {
  try {
    const response = await fetch(`${baseUrl}/api/CartItem/cart/${currentcartId}`);
    const items = await response.json();

    let totalQty = 0;
    let subtotal = 0;       // product-only subtotal
    let totalTax = 0;       // aggregated state+local tax
    let totalAdults = 0;
    let totalChildren = 0;

    items.forEach(item => {
      const qty = item.itemqty ?? 0;
      const itemSubtotal = item.itemsubtotal ?? 0;
      const itemTax = item.statetaxtotal ?? 0;

      totalQty += qty;
      subtotal += itemSubtotal;
      totalTax += itemTax;

      // ✅ Adults and children only count for class P tickets
      //if (item.productclass === 'P') {
        totalAdults += item.adults ?? 0;
        totalChildren += item.children ?? 0;
      //}
    });

      // Get the Adults value
      let globaladults = document.getElementById("globalAdults").value;

      // Get the Children value
      let globalchildren = document.getElementById("globalChildren").value;

      // Get the TentSites value
      let globaltentSites = document.getElementById("globalTentSites").value;



    const totalPrice = subtotal + totalTax;

    let somedescription = "";
    if (totalQty === 1) {
      somedescription = "Single Item";
    } else if (totalQty === 2) {
      somedescription = "Two Items";
    } else {
      somedescription = "More Than Two Items in Cart";
    }

    const cartUpdate = {
      cartId: currentcartId,
      totalcartitems: totalQty,
      subtotal: subtotal,          // sum of product subtotals
      unitPrice: totalTax,         // sum of tax totals
      totalPrice: totalPrice.toFixed(2),      // subtotal + tax
      itemDescription: somedescription,
      adults: globaladults,         // only class P adults
      children: globalchildren,      // only class P children
      tentsites: globaltentSites
    };

    await fetch(`${baseUrl}/api/Cart/${currentcartId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(cartUpdate)
    });

    console.log(`✅ Cart ${currentcartId} updated: ${totalQty} items, subtotal $${subtotal.toFixed(2)}, tax $${totalTax.toFixed(2)}, total $${totalPrice.toFixed(2)}, adults ${totalAdults}, children ${totalChildren}`);
    console.log(cartUpdate);
  } catch (err) {
    console.error("❌ Failed to update cart totals:", err);
  }
}
async function setCartTotals() {
      try {
        const response = await fetch(`${baseUrl}/api/CartItem/cart/${cartId}`);
        const items = await response.json();

        let totalQty = 0;
        let totalPrice = 0;
        let totalAdults = 0;
        let totalChildren = 0;

        items.forEach(item => {
          totalQty += item.itemqty ?? 0;
          totalPrice += item.itemtotals ?? 0;
          totalAdults += item.adults ?? 0;
          totalChildren += item.children ?? 0;
        });
          // Get the Adults value
          let globaladults = document.getElementById("globalAdults").value;

          // Get the Children value
          let globalchildren = document.getElementById("globalChildren").value;

          // Get the TentSites value
          let globaltentSites = document.getElementById("globalTentSites").value;

      
       	let somedescription = "";
      	if(totalQty == 1)
        {
        somedescription = "Single Item";
        }
        else if(totalQty == 2)
        {
        somedescription = "Two Items";
        }
        else
        {
        somedescription = "More Than Two Items in Cart";
        }
            
        const cartUpdate = {
          totalcartitems: totalQty,
          transactiontotal: totalPrice,
          itemDescription: somedescription,
          adults: globaladults,
          children: globalchildren,
          tensites: globaltentSites
        };

        await fetch(`${baseUrl}/api/Cart/${cartId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(cartUpdate)
        });

        console.log(`✅ Cart ${cartId} updated: ${totalQty} items, $${totalPrice.toFixed(2)}`);
        console.log(cartUpdate);
        alert('Cart Parent Updated! Click to Proceed to Payment');
      } catch (err) {
        console.error("❌ Failed to update cart totals:", err);
      }
    }

//PART5 - MODAL FORM SCRIPTS TO CREATE RESERVATION SHELL
 

function openReservationModal() {
  // Show the modal
  document.getElementById("reservationModal").style.display = "flex";

  // Get today's date in YYYY-MM-DD format
  const today = new Date().toISOString().split("T")[0];

  // Set the MODAL date fields (replace with your modal IDs)
  document.getElementById("modalStartDate").value = today;
  document.getElementById("modalEndDate").value = today;
}

  function submitModalDetails() {
    const adults = document.getElementById("modalAdults").value;
    const children = document.getElementById("modalChildren").value;
    const startDate = document.getElementById("modalStartDate").value;
    const endDate = document.getElementById("modalEndDate").value;
    const gtents = document.getElementById("modalTentSites").value;
    alert("Calling SubmitModal");
    // ✅ Update your existing global fields
    document.getElementById("globalAdults").value = adults;
    document.getElementById("globalChildren").value = children;
    document.getElementById("globalStartDate").value = startDate;
    document.getElementById("globalEndDate").value = endDate;
    document.getElementById("globalTentSites").value = gtents;


    // Close modal
    document.getElementById("reservationModal").style.display = "none";
  }

  function closeReservationModal() {
    document.getElementById("reservationModal").style.display = "none";
  }

function inc(id) {
  const el = document.getElementById(id);
  el.value = Number(el.value || 0) + 1;
}

function dec(id) {
  const el = document.getElementById(id);
  const newVal = Number(el.value || 0) - 1;
  el.value = newVal < 0 ? 0 : newVal;
}


// --- Initialization ---
document.addEventListener('DOMContentLoaded', async () => {
  await ensureCartMasterExists();
  await displayCartMaster();
  await loadParksDropdown();
  await loadParkSummary();
  await loadCatalogue();
});
</script>
</body>
<footer class="footer"> &copy; Cocky Consulting 2025. <br> All rights reserved.<br>  <span align="center"><a href="sitemap.html" class="sitelink">SiteMap</a></span></footer>
</html>





















































