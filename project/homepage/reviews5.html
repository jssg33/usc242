<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product Reviews</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script type="module" src="https://esm.run/@material/web/all.js"></script>
  <link rel="stylesheet" href="./css/site.css">
  <link rel="stylesheet" href="./css/layout.css">
  <link rel="stylesheet" href="./css/greenville.css">
  <script src="./js/bikes.js"></script>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <style>
    
  </style>
</head>
<body onload="checkpll(); checkUserStatus(); displayProfilePicture();">
  <!-- Navigation Bar -->
  <div class="navbar">
    <div class="nav-left">
      <div class="dropdown">
        <button class="jsmenu"><img src="./images/greenmenu5.png" alt="Menu"></button>
        <div class="dropdown-content">
            	<a href="index.html">Home</a>
			      <a href="login.html">Login</a>
            <a href="logout.html">Logout</a>
            <a href="welcome.html">Welcome</a>
            <a href="licenses6.html">BuyNow</a>
            <a href="reviews.html">AllReviews</a>
            <a href="mylicenselogs.html">MyLicenseLogs</a>
            <a href="mylicenses.html">MyLicenses</a>
            <a href="./pricing/wizard.html">PricingWizard</a>
            <a href="mycart.html?uid=1">MyCart</a>
            <a href="myprofile.html">MyProfile</a>
            <a href="testimonials.html">AdminTestimonials</a>
            <a href="products.html">AdminProducts</a>
            <a href="licensetypes.html">AdminLicenseTypes</a>
	   <a href="template.html">AdminPageTemplate</a>
        </div>
      </div>
      <div class="logo">&nbsp;&nbsp;&nbsp;<h5 class="mb-0">MyLinkv25 - ParkReviews</h5></div>
    </div>
    <div class="nav-right">
      <img src="./images/bluecircle.png" id="profilephototarget" alt="User" style="cursor:pointer;" onclick="window.location.href='profile.html'" />
      <span id="H3UserBanner"></span>
      <a href="index.html" id="homeBtn" class="btn secondary-btn">Home</a>
      <a href="login.html" id="loginBtn" class="btn secondary-btn" onclick="loginUser(event)">Login</a>
      <a href="login.html" id="logoutBtn" class="btn secondary-btn" onclick="logoutUser(event)">Logout</a>
              <a href="cartreview.html" id="cartBtn3"><img src="./images/cart4.png" width="40px" height="40px"></a>
    </div>
  </div>

  <div id="banner" class="text-center">
    <span id="userGreeting">Welcome Guest</span>
  </div>

  <br><br><br>

  <!-- Park Summary Card -->
  <div id="park-details" class="mb-5"></div>

  <!-- Review Header and Add Button -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">Visitor Reviews</h4>
  </div>
  <div class="mb-3">
    <button id="addreview" class="btn btn-secondary float-start" data-bs-toggle="modal" data-bs-target="#reviewModal">Add Review</button>
  </div>

  <!-- Reviews Grid -->
  <div id="reviews-grid" class="row g-4"></div>

  <br><br>

  <!-- Review Modal -->
  <div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="review-form" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reviewModalLabel">Submit a Review</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <input type="hidden" id="userId" name="userId">
            </div>
          <div class="mb-3">
            <label for="stars" class="form-label">Rating</label>
            <select class="form-select" id="stars" required>
              <option value="">Choose...</option>
              <option value="5">★★★★★</option>
              <option value="4">★★★★☆</option>
              <option value="3">★★★☆☆</option>
              <option value="2">★★☆☆☆</option>
              <option value="1">★☆☆☆☆</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="description" class="form-label">Review</label>
            <textarea class="form-control" id="description" rows="3" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Submit Review</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    $(document).ready(function () {
      const params = new URLSearchParams(window.location.search);
      const parkId = params.get("parkId");

      if (!parkId) {
        $("#park-details").html(`<div class="alert alert-danger">No parkId provided in URL.</div>`);
        return;
      }

     // Listener for Add Review button
  $("#addreview").on("click", function () {
    const someuid = localStorage.getItem("uid");
    if (someuid) {
      $("#userId").val(someuid);
      // optional: make it readonly so users don’t change it
      // $("#userId").prop("readonly", true);
    }
  });
    
    
    
      // Load park info
      $.get(`https://api242.onrender.com/Parks/${parkId}`, function (park) {
        if (Array.isArray(park)) park = park[0];
        if (!park) {
          $("#park-details").html(`<div class="alert alert-warning">No park found for ID ${parkId}.</div>`);
          return;
        }

        const mapsLink = `https://www.google.com/maps?q=${park.latitude},${park.longitude}`;
        const directionsLink = `https://www.google.com/maps/dir/?api=1&destination=${park.latitude},${park.longitude}`;
        const pictureurl = `https:// home.547bikes.info/picturewall.html?parkId=${park.parkId}`;
        localStorage.setItem("ParkIdAsString", park.id);
        localStorage.setItem("ParkName", park.name);
        let temp = localStorage.getItem("fullname");
        localStorage.setItem("DisplayName", temp);
        $("#park-details").html(`
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-center mb-3">
                ${park.parklogourl ? `<img src="${park.parklogourl}" alt="Park Logo" class="me-3" style="height:60px;" onerror="this.style.display='none';">` : ""}
                <h3 class="card-title mb-0">${park.name}</h3>
              </div>
              <p><strong>Region:</strong> ${park.region}</p>
              <p><strong>Address:</strong> ${park.address}</p>
              <p><strong>Phone:</strong> ${park.phone}</p>
              <p><strong>Trail Length:</strong> ${park.trailLengthMiles} miles</p>
              <p><strong>Difficulty:</strong> ${park.difficulty}</p>
              <p><strong>Day Pass:</strong> $${typeof park.dayPassPriceUsd === "number" ? park.dayPassPriceUsd.toFixed(2) : "N/A"}</p>
              <p><strong>Description:</strong> ${park.description}</p>
              <p><strong>GPS:</strong> ${park.latitude}, ${park.longitude}</p>
              <p><strong>Visitors:</strong> ${park.currentvisitors} / ${park.maxvisitors} (Adults: ${park.currentvisitorsadults}, Children: ${park.currentvisitorschildren})</p>
              <p><strong>Campsites:</strong> ${park.currentcampsites || 0} / ${park.maxcampsites}</p>
              ${park.trailmapurl
                ? `<a href="${park.trailmapurl}" class="btn btn-primary btn-sm mt-2" target="_blank">Trail Map</a>`
                : `<span class="text-muted">No trail map available</span>`}
              <a href="${mapsLink}" class="btn btn-outline-secondary btn-sm mt-2 ms-2" target="_blank">Open in Google Maps</a>
              <a href="${directionsLink}" class="btn btn-outline-primary btn-sm mt-2 ms-2" target="_blank">Get Driving Directions</a>
              <a href="${pictureurl}" class="btn btn-outline-primary btn-sm mt-2 ms-2" target="_blank">View Park Pictures</a>
            </div>
          </div>
        `);
      });

      // Load reviews (scoped to the same ready block so parkId is available)
      function loadReviews() {
        $.get("https://api242.onrender.com/ParkReview", function (reviews) {
          const pId = Number(parkId);
          const filtered = (reviews || []).filter(r => Number(r.parkId) === pId);

          if (!filtered.length) {
            $("#reviews-grid").html(`<div class="col-12"><p class="text-muted">No reviews yet.</p></div>`);
            return;
          }

          $("#reviews-grid").html(filtered.map(r => `
            <div class="col-md-6 col-lg-4">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <h5 class="card-title">User #${r.userId}</h5>
                  <p class="text-warning">${"★".repeat(r.stars)}${"☆".repeat(5 - r.stars)}</p>
                  <p class="card-text">${r.description}</p>
                  <p class="text-muted small">Posted: ${new Date(r.datePosted).toLocaleDateString()}</p>
                </div>
              </div>
            </div>
          `).join(""));
        });
      }

      loadReviews();

      // Submit review (Bootstrap 5 modal hide via JS API)
      $("#review-form").on("submit", function (e) {
        e.preventDefault();

const someparkid = localStorage.getItem("ParkIdAsString");
const someparkname = localStorage.getItem("ParkName");


const review = {
  parkId: Number(parkId),                  // the int foreign key
  parkIdAsString: someparkid,   // the GUID from Parks table
  parkName: someparkname,       // park name from Parks API
  userId: Number($("#userId").val()),      // int user id
  useridasstring: $("#userId").val().toString(), // string version of user id
  displayname: localStorage.getItem("DisplayName") || "Guest",
  fullname: localStorage.getItem("fullname") || "Anonymous",
  description: $("#description").val(),
  stars: Number($("#stars").val()),
  datePosted: new Date().toISOString(),
  dateApproved: null,
  dateDenied: null,
  reasonDescription: null,
  reviewManagerId: 0,
  active: true,
  parkGuid: someparkid
};

           $.ajax({
          url: "https://api242.onrender.com/ParkReview",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify(review),
          success: function () {
            const modalEl = document.getElementById("reviewModal");
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.hide();

            $("#review-form")[0].reset();
            loadReviews();
          },
          error: function () {
            alert("Failed to submit review.");
          }
        });
      });
    });
  </script>

  <footer class="footer text-center mt-4 mb-3">
    &copy; Greenville Associates Consulting 2026, FusionCommerce, Inc.<br>All rights reserved.<br>
    <span><a href="sitemap.html" class="sitelink">SiteMap</a></span>
  </footer>
</body>
</html>

