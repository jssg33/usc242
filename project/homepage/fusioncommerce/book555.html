<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script type="module" src="https://esm.run/@material/web/all.js"></script>

  <link rel="stylesheet" href="./css/fusioncart.css" />

  <script src="./js/products.js"></script>
  <script src="./js/cart.js"></script>

  <title>Fusion Commerce Cart V2.0</title>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>

<body onload="loadProductSummary(); loadCartMaster(); checkpll(); checkUserStatus(); displayProfilePicture();">

  <!-- Navigation Bar -->
  <div class="navbar">
    <div class="nav-left">
      <div class="dropdown">
        <button class="jsmenu"><img src="./images/greenmenu5.png"></button>
        <div class="dropdown-content">
          <a href="index.html">Home</a>
          <a href="login.html">Login</a>
          <a href="logout.html">Logout</a>
          <a href="welcome.html">Welcome</a>
          <a href="products.html">Products</a>
          <a href="mycart.html">My Cart</a>
          <a href="myprofile.html">My Profile</a>
          <a href="admin/products.html">Admin Products</a>
          <a href="admin/templates.html">Admin Templates</a>
        </div>
        <div class="logo">&nbsp;&nbsp;Fusion Commerce - Product Review</div>
      </div>
    </div>

    <div class="nav-right">
      <img src="./images/blackcircle.png" id="profilephototarget" alt="User" onclick="window.location.href='../myprofile.html'" />
      <span id="H3UserBanner"></span>
      <a href="login.html" id="loginBtn" class="btn secondary-btn">Login</a>
      <a href="logout.html" id="logoutBtn" class="btn secondary-btn">Logout</a>
      <a href="cartreview.html" id="cartBtn3"><img src="./images/cart4.png" width="40" height="40"></a>
    </div>
  </div>

  <div align="center" id="banner"><span id="userGreeting">Welcome Guest</span></div>
  <br><br>

  <!-- ========================= -->
  <!-- TOP PANELS: PRODUCTS + CARTMASTER -->
  <!-- ========================= -->
  <div class="top-panels">

    <!-- PRODUCT PANEL -->
    <div class="product-panel">
      <h3>Product Info</h3>
      <hr>

      <label><strong>Current Product:</strong></label>
      <span id="currentProductId"></span> -
      <span id="currentProductName"></span>

      <br><br>

      <label for="productSelector">Select Product:</label>
      <select id="productSelector" onchange="changeProduct()">
        <option value="">Choose a Product</option>
      </select>

      <hr>
      <div id="product-details"></div>
    </div>

    <!-- CARTMASTER PANEL -->
    <div class="cartmaster-panel">
      <h3>Cart Master Summary</h3>
      <hr>

      <div id="cartMasterCard">
        <p><strong>User ID:</strong> <span id="cmUserId"></span></p>
        <p><strong>Loyalty ID:</strong> <span id="cmLoyaltyId"></span></p>
        <p><strong>Vendor:</strong> <span id="cmVendor"></span></p>
        <p><strong>Carts Count:</strong> <span id="cmCartsCount"></span></p>
        <p><strong>Active Carts:</strong> <span id="cmCartsActive"></span></p>
        <p><strong>Cancelled Carts:</strong> <span id="cmCartsCancelled"></span></p>
        <p><strong>Active List:</strong> <span id="cmCartsActiveList"></span></p>

        <button onclick="createNewCart()">Add New Cart</button>
      </div>
    </div>

  </div>

  <hr>

  <!-- ========================= -->
  <!-- PRODUCT OPTIONS + SALES GRID -->
  <!-- ========================= -->
  <div id="productstuff">

    <div id="interiorpanel">
      <h4>Product Options</h4>

      <div class="master-row">

        <!-- LEFT COLUMN -->
        <div class="left-column">
          <h5>Order Basics</h5>

          <label>Quantity:</label>
          <input type="number" id="globalQuantity" min="1" value="1" style="width:60px;">
        </div>

        <!-- RIGHT COLUMN -->
        <div class="right-column">
          <h5>Preferences</h5>
          <div class="interests-block">
            <label><input type="checkbox" value="giftwrap"> Gift Wrap</label>
            <label><input type="checkbox" value="express"> Express Shipping</label>
            <label><input type="checkbox" value="insurance"> Add Insurance</label>
          </div>
        </div>

      </div>
    </div>

    <div class="row" id="salesgrid">

      <!-- PRODUCT CATALOG -->
      <div class="columnproducts">
        <h3>Products</h3>
        <hr>
        <select id="catalogue" multiple></select>
      </div>

      <!-- ACTIONS -->
      <div class="columnactions">
        <h3>Actions</h3>
        <hr>
        <button onclick="moveToSelected()">Add Item(s)</button><br><br>
        <button onclick="moveToCatalogue()">Remove Item(s)</button><br><br>
        <button onclick="addSelectedToCart()">Save Item(s)</button>
      </div>

      <!-- SELECTED ITEMS -->
      <div class="columnselected">
        <h3>Selected</h3>
        <hr>
        <table id="selected">
          <thead>
            <tr>
              <th>Description</th>
              <th>Price</th>
              <th>Qty</th>
              <th>Subtotal</th>
              <th>State Tax (6%)</th>
              <th>Local Tax (1.5%)</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div>
  </div>

  <hr>

  <!-- ========================= -->
  <!-- PRODUCT OPTIONS MODAL -->
  <!-- ========================= -->
  <div id="productOptionsModal">
    <div class="modal-content">
      <h3>Product Options</h3>

      <label>Quantity:</label>
      <input type="number" id="modalQuantity" value="1" min="1">

      <br><br>
      <button onclick="submitProductOptions()">Submit</button>
      <button onclick="closeProductOptionsModal()">Close</button>
    </div>
  </div>

  <!-- ========================= -->
  <!-- YOUR FUNCTIONS (INSERTED) -->
  <!-- ========================= -->
  <script>
    /* All your provided functions are placed here exactly as given */

    function setuser() {
      alert("setting user for trial usage");
      localStorage.setItem("uid", "1");
      localStorage.setItem("fullname", "Park Guest");
      localStorage.setItem("email", "parkguest@547bikes.info");
      localStorage.setItem("role", "registered");
      localStorage.setItem("status", "loggedin");
      localStorage.setItem("firstname", "Park");
      localStorage.setItem("lastname", "Guest");
    }

    function checkpll() {
      const someuid = localStorage.getItem('uid');
      if (someuid === '901') {
        window.location.href = 'loginerror.html';
      } else if (!someuid) {
        localStorage.setItem("uid", "901");
        localStorage.setItem("fullname", "Park Guest");
      }
    }

    function displayProfilePicture() {
      var newSrc = './images/bluecircle.png';
      const imageElement = document.getElementById("profilephototarget");

      const tempSrc = localStorage.getItem("activepictureurl");
      if (tempSrc !== null) {
        newSrc = tempSrc;
      }
      imageElement.src = newSrc;
    }

    function checkUserStatus() {
      var userId = localStorage.getItem("uid");
      var fullName = localStorage.getItem("fullname");
      var userRole = localStorage.getItem("role");

      var loginBtn = document.getElementById("loginBtn");
      var logoutBtn = document.getElementById("logoutBtn");

      if (userId && userId !== "901") {
        document.getElementById("userGreeting").innerHTML = "Welcome, " + fullName;
        document.getElementById("H3UserBanner").innerText = fullName;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";

        if (userRole === "admin") {
          window.open("adminhome.html", "_self");
        }
      } else {
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        document.getElementById("userGreeting").innerHTML = "Welcome, Guest";
        document.getElementById("H3UserBanner").innerText = "Guest";
        document.getElementById("profilephototarget").src = "./images/bluecircle.png";
      }
    }

    function logoutUser(event) {
      event.preventDefault();
      localStorage.clear();
      localStorage.setItem("uid", "901");
      localStorage.setItem("fullname", "Guest");
      localStorage.setItem("role", "guest");
      clearUserSession();
      window.location.replace("login.html");
    }

    function clearUserSession() {
      let sometoken = localStorage.getItem('token');
      let logoutApiUrl = "https://api242.onrender.com/api/Users/logout/" + sometoken;

      $.post(logoutApiUrl)
        .done(function () {
          alert("SessionClosed.");
        })
        .fail(function (xhr) {
          console.error("Error closing session:", xhr.responseText);
        });
    }

    function loginUser(event) {
      event.preventDefault();
      localStorage.clear();
      localStorage.setItem("uid", "901");
      localStorage.setItem("fullname", "Guest");
      localStorage.setItem("role", "guest");
      localStorage.setItem("isemployee", "0");
      window.open("login.html", "_self");
    }

    function fetchProfilePicture() {
      let uid = localStorage.getItem('uid');
      $.get("https://api242.onrender.com/api/Userprofile")
        .done(function (profiles) {
          let profile = profiles.find(p => p.userid == uid);
          if (profile && profile.activepictureurl) {
            $('.navbar .nav-right img').attr('src', profile.activepictureurl);
          }
        })
        .fail(function (xhr) {
          console.error("Error fetching profiles:", xhr.responseText);
        });
    }

    function fetchUser() {
      let uid = localStorage.getItem('uid');
      $.get("https://api242.onrender.com/api/Users")
        .done(function (users) {
          let user = users.find(u => u.id == uid);
          if (!user) {
            alert("User not found.");
            return;
          }
          $('#H3UserBanner').text(user.fullname);
        })
        .fail(function (xhr) {
          console.error("Error fetching user:", xhr.responseText);
        });
    }

    function checkUserRole() {
      const userRole = localStorage.getItem("role");
      if (userRole != "superuser") {
        document.getElementById("manager").style.display = "none";
      }
    }

    function fetchSyslog() {
      $.get("https://api242.onrender.com/api/Userlog")
        .done((data) => $("#syslogDisplay").text(JSON.stringify(data, null, 2)))
        .fail(() => $("#syslogDisplay").text("Error fetching syslog"));
    }

    function fetchSessionlog() {
      $.get("https://api242.onrender.com/api/Usersession")
        .done((data) => $("#sessionlogDisplay").text(JSON.stringify(data, null, 2)))
        .fail(() => $("#sessionlogDisplay").text("Error fetching syslog"));
    }

    function fetchApilog() {
      $.get("https://api242.onrender.com/api/Useraction")
        .done((data) => $("#apilogDisplay").text(JSON.stringify(data, null, 2)))
        .fail(() => $("#apilogDisplay").text("Error fetching apilog"));
    }

    function fetchLearnlog() {
      $.get("https://api242.onrender.com/api/Learndetail")
        .done((data) => $("#learnlogDisplay").text(JSON.stringify(data, null, 2)))
        .fail(() => $("#learnlogDisplay").text("Error fetching learnlog"));
    }

    function onLogout(event) {
      event.preventDefault();
      localStorage.clear();
      localStorage.setItem("uid", "901");
      localStorage.setItem("fullname", "Guest");
      localStorage.setItem("role", "guest");
      localStorage.setItem("isemployee", "0");
      closeUserSession();
      window.location.replace("../login.html");
    }

    function writelocation() {
      const locElement = document.getElementById("locationbar");
      const ipElement = document.getElementById("ipbar");

      somefulllocation = localStorage.getItem("userlocation");
      someipaddress = localStorage.getItem("ipaddress");

      if (somefulllocation) {
        locElement.innerHTML = `Your Location is: ${somefulllocation}`;
        ipElement.innerHTML = `Your IP is: ${someipaddress}`;
      } else {
        locElement.innerHTML = "Location data not available.";
        ipElement.innerHTML = `Your IP address is not available.`;
      }
    }

    function closeUserSession() {
      const uid = localStorage.getItem('uid');
      if (!uid) return;

      const payload = { sessionend: new Date().toISOString() };

      fetch(`https://api242.onrender.com/Usersession/user/${uid}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
        .then(response => response.json())
        .then(data => console.log('Session closed:', data))
        .catch(error => console.error('Error closing session:', error));
    }

  </script>

</body>

<footer class="footer">
  &copy; Greenville Associates Consulting, Inc.<br>
  All rights reserved.<br>
  <a href="sitemap.html" class="sitelink">SiteMap</a>
</footer>

</html>
