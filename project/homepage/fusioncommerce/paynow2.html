<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FusionCommerce – Complete Payment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script type="module" src="https://esm.run/@material/web/all.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <link rel="stylesheet" href="./css/fusioncart.css" />

  <style>
    .table-striped tbody tr:nth-of-type(odd) {
      background-color: #f9f9f9;
    }
    #banner {
      background-color: #198754;
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
    }
  </style>
</head>
<body onload="checkpll(); checkUserStatus(); displayProfilePicture();">
  <!-- Navigation Bar -->
  <div class="navbar">
    <div class="nav-left">
      <div class="dropdown">
        <button class="jsmenu"><img src="./images/greenmenu5.png"></button> 
        <div class="dropdown-content">
          <a href="index.html">Home</a>
          <a href="purchase555.html">BuyNow</a>
          <a href="cartreview.html">My Carts</a>
          <a href="mypurchases5.html">My Purchases</a>
          <a href="myinvoices.html">My Invoices</a>
          <a href="myprofile.html">MyProfile</a>
        </div>
      </div> 
      <div class="logo">&nbsp&nbsp;<h5>FusionCommerce – Complete Payment</h5></div>
    </div>
    <div class="nav-right">
      <img src="./images/blackcircle.png" id="profilephototarget" alt="User" onclick="window.location.href='myprofile.html'" />
      <span id="H3UserBanner"></span>
      <div class="right-links" style="display:flex; gap:6px; align-items:center; color: white;">
        <md-text-button class="icon-only" href="index.html" aria-label="Home" title="Home">
          <span class="material-icons" style="color:white;">home</span>
        </md-text-button>
        <md-text-button class="icon-only" href="userhelp.html" aria-label="Help" title="Help">
          <span class="material-icons" style="color:white;">help_outline</span>
        </md-text-button>
        <md-text-button class="icon-only" href="usernotices.html" aria-label="Notifications" title="Notifications">
          <span class="material-icons" style="color:white;">notifications</span>
        </md-text-button>
        <md-text-button class="icon-only" href="login.html" aria-label="Login" title="Login">
          <span class="material-icons" style="color:white;">login</span>
        </md-text-button>
        <md-text-button class="icon-only" href="logout.html" aria-label="Logout" title="Logout">
          <span class="material-icons" style="color:white;">logout</span>
        </md-text-button>
        <md-text-button class="icon-only" href="myprofile.html" aria-label="My Profile" title="My Profile">
          <span class="material-icons" style="color:white;">person</span>
        </md-text-button>
        <md-text-button class="icon-only" href="cartreview.html" aria-label="My Cart" title="My Cart">
          <span class="material-icons" style="color:white;">shopping_cart</span>
        </md-text-button>
      </div>
    </div>
  </div>

  <div align="center" id="banner"><span id="userGreeting">Welcome Guest</span></div>

  <section class="top-section container mt-4">
    <h2>Choose a Credit Card</h2>

    <div id="no-card-message" class="mt-3 text-danger fw-bold"></div>
    <div class="mb-2">
      <button id="add-card-button" class="btn btn-secondary mt-2" data-bs-toggle="modal" data-bs-target="#addCardModal">Add Card</button>
    </div>

    <table class="table table-bordered table-striped mt-4">
      <thead class="table-dark">
        <tr>
          <th>Card Type</th>
          <th>Vendor</th>
          <th>Last 4 Digits</th>
          <th>Expiration</th>
          <th>Billing Zip</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="card-table-body"></tbody>
    </table>

    <div id="payment-status" class="mt-4"></div>
    <div align="center" class="mt-3">
      <button id="reviewreservations" class="btn btn-info" onclick="window.location.href='mypurchases5.html'">Review My Reservations</button>
    </div>

    <!-- Add Card Modal -->
    <div class="modal fade" id="addCardModal" tabindex="-1" aria-labelledby="addCardModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <form id="add-card-form" class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addCardModalLabel">Add New Card</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="card-uid">
            <div class="mb-3">
              <label for="cardType" class="form-label">Card Type</label>
              <input type="text" class="form-control" id="cardType" required>
            </div>
            <div class="mb-3">
              <label for="cardVendor" class="form-label">Card Vendor</label>
              <input type="text" class="form-control" id="cardVendor" required>
            </div>
            <div class="mb-3">
              <label for="cardLast4" class="form-label">Last 4 Digits</label>
              <input type="text" class="form-control" id="cardLast4" maxlength="4" required>
            </div>
            <div class="mb-3">
              <label for="cardExpDate" class="form-label">Expiration Date</label>
              <input type="text" class="form-control" id="cardExpDate" placeholder="MM/YY" required>
            </div>
            <div class="mb-3">
              <label for="billingZip" class="form-label">Billing Zip</label>
              <input type="text" class="form-control" id="billingZip" required>
            </div>
            <div class="mb-3">
              <label for="cardbtn" class="form-label">Card Billing Telephone Number</label>
              <input type="text" class="form-control" id="cardbtn">
            </div>
            <div class="mb-3">
              <label for="fullname" class="form-label">Card Name As Printed</label>
              <input type="text" class="form-control" id="fullname">
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Save Card</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Update Card Modal -->
    <div class="modal fade" id="updateCardModal" tabindex="-1" aria-labelledby="updateCardModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <form id="update-card-form" class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="updateCardModalLabel">Update Card</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="update-cardId">
            <div class="mb-3">
              <label for="update-cardType" class="form-label">Card Type</label>
              <input type="text" class="form-control" id="update-cardType">
            </div>
            <div class="mb-3">
              <label for="update-cardVendor" class="form-label">Card Vendor</label>
              <input type="text" class="form-control" id="update-cardVendor">
            </div>
            <div class="mb-3">
              <label for="update-cardLast4" class="form-label">Last 4 Digits</label>
              <input type="text" class="form-control" id="update-cardLast4" maxlength="4">
            </div>
            <div class="mb-3">
              <label for="update-cardExpDate" class="form-label">Expiration Date</label>
              <input type="text" class="form-control" id="update-cardExpDate" placeholder="MM/YY">
            </div>
            <div class="mb-3">
              <label for="update-billingZip" class="form-label">Billing Zip</label>
              <input type="text" class="form-control" id="update-billingZip">
            </div>
            <div class="mb-3">
              <label for="update-cardbtn" class="form-label">Billing Telephone Number</label>
              <input type="text" class="form-control" id="update-cardbtn">
            </div>
            <div class="mb-3">
              <label for="update-fullname" class="form-label">Card Name As Printed</label>
              <input type="text" class="form-control" id="update-fullname">
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Update Card</button>
          </div>
        </form>
      </div>
    </div>
  </section>

  <footer class="footer text-center mt-5">
    &copy; Cocky Consulting 2025. <br> All rights reserved.<br>
    <span><a href="sitemap.html" class="sitelink">SiteMap</a></span>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API = "https://api242.onrender.com";

    const urlParams = new URLSearchParams(window.location.search);
    const uid = urlParams.get("uid") || localStorage.getItem("uid") || "1";
    const amount = parseFloat(urlParams.get("amount") || "0.00");
    const cartId = urlParams.get("cartId");

    document.getElementById("card-uid").value = uid;

    function generateTransactionId() {
      const letters = Array.from({ length: 3 }, () =>
        String.fromCharCode(65 + Math.floor(Math.random() * 26))
      ).join("");
      const digits = Math.floor(100000000 + Math.random() * 900000000).toString();
      return letters + digits;
    }

    async function fetchCards(uid) {
      const res = await fetch(`${API}/cards?uid=${uid}`);
      if (!res.ok) return [];
      return res.json();
    }

    function renderCards(cards) {
      const tbody = document.getElementById("card-table-body");
      const noCardMsg = document.getElementById("no-card-message");
      tbody.innerHTML = "";

      if (!cards || cards.length === 0) {
        noCardMsg.textContent = "No credit card on file. Please add one to proceed.";
        return;
      }

      noCardMsg.textContent = "";

      cards.forEach(card => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${card.cardType}</td>
          <td>${card.cardVendor}</td>
          <td>${card.cardLast4}</td>
          <td>${card.cardExpDate}</td>
          <td>${card.billingZip}</td>
          <td>
            <button class="btn btn-primary btn-sm" onclick='simulatePayment(${JSON.stringify(card)})'>
              Pay $${amount.toFixed(2)}
            </button>
            <button class="btn btn-warning btn-sm ms-2" onclick='openUpdateModal(${JSON.stringify(card)})'>
              Update Card
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    async function refreshCards() {
      const cards = await fetchCards(uid);
      renderCards(cards);
    }

    refreshCards();

    async function simulatePayment(card) {
      if (!cartId) {
        alert("Missing cart information.");
        return;
      }

      if (!confirm(`Confirm payment of $${amount.toFixed(2)} using card ending in ${card.cardLast4}?`)) return;

      try {
        // Load cart items
        const itemsRes = await fetch(`${API}/cartitems/cart/${cartId}`);
        if (!itemsRes.ok) throw new Error("Failed to load cart items");
        const items = await itemsRes.json();

        if (!items || items.length === 0) {
          alert("No items found in this cart.");
          return;
        }

        const isReservation = items.some(i => i.resStart && i.resEnd);
        const paymentType = isReservation ? "Reservation" : "Invoice";

        const transactionId = generateTransactionId();

        // 1️⃣ Create Payment
        const paymentData = {
          paymentId: 0,
          cartid: cartId,
          bookingId: 0,
          paymentMethod: "Credit Card",
          cardType: card.cardType,
          cardLast4: card.cardLast4,
          cardExpDate: card.cardExpDate,
          amountPaid: amount,
          amountRefunded: 0,
          paymentDate: new Date().toISOString(),
          transactionId: transactionId,
          refundTransactionid: "",
          useridasstring: uid.toString(),
          transtype: "Payment",
          fullname: card.fullname || ""
        };

        await fetch(`${API}/payments`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(paymentData)
        });

        // 2️⃣ Create Reservation or Invoice
        if (paymentType === "Reservation") {
          const first = items[0];
          const reservation = {
            bookingId: 0,
            uid: uid,
            billingTelephoneNumber: card.cardbtn || "",
            creditCardType: card.cardType,
            creditCardLast4: card.cardLast4,
            creditCardExpDate: card.cardExpDate,
            quantityAdults: 0,
            quantityChildren: 0,
            customerBillingName: card.fullname || "",
            totalAmount: amount,
            transactionId: transactionId,
            parkId: 0,
            parkName: "",
            cartid: cartId.toString(),
            reservationtype: "Reservation",
            reservationstatus: "Active",
            reversetransactionid: "",
            cancellationrefund: 0,
            cartDetailsJson: "",
            totalcartitems: items.length,
            reference: "",
            subReference: "",
            adults: 0,
            children: 0,
            resStart: first.resStart,
            resEnd: first.resEnd,
            tentsites: 0,
            parkGuid: "",
            numDays: 0,
            possource: "FusionCommerce",
            userid: parseInt(uid) || 0,
            emailnoticeaddress: "",
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };

          await fetch(`${API}/reservations`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(reservation)
          });

          document.getElementById("payment-status").innerHTML = `
            <p class="fw-bold text-success">✅ Payment of $${amount.toFixed(2)} processed.</p>
            <p>Transaction ID: <strong>${transactionId}</strong></p>
            <p>Type: Reservation</p>
          `;
          alert("Reservation completed successfully.");
          window.location.href = "mypurchases5.html";

        } else {
          const invoice = {
            invoiceId: 0,
            customerId: uid,
            accountId: "",
            subAccountId: "",
            billToAddress1: "",
            billToAddress2: "",
            billToCity: "",
            billToState: "",
            billToPostalZip: "",
            billToCountry: "",
            shipToAddress1: "",
            shipToAddress2: "",
            shipToCity: "",
            shipToState: "",
            shipToPostalZip: "",
            shipToCountry: "",
            subtotal: amount,
            taxTotal: 0,
            discountTotal: 0,
            grandTotal: amount,
            invoiceDate: new Date().toISOString(),
            dueDate: new Date().toISOString(),
            status: "paid",
            notes: "",
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            cartId: cartId
          };

          await fetch(`${API}/invoices`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(invoice)
          });

          document.getElementById("payment-status").innerHTML = `
            <p class="fw-bold text-success">✅ Payment of $${amount.toFixed(2)} processed.</p>
            <p>Transaction ID: <strong>${transactionId}</strong></p>
            <p>Type: Invoice</p>
          `;
          alert("Invoice created successfully.");
          window.location.href = "myinvoices.html";
        }

      } catch (err) {
        console.error("Error during payment:", err);
        document.getElementById("payment-status").innerHTML = `
          <p class="text-danger">❌ Payment failed. Please try again.</p>
        `;
      }
    }

    document.getElementById("add-card-form").addEventListener("submit", async function (e) {
      e.preventDefault();

      const newCard = {
        cardId: 0,
        uid: uid,
        cardType: document.getElementById("cardType").value,
        cardVendor: document.getElementById("cardVendor").value,
        cardLast4: document.getElementById("cardLast4").value,
        cardExpDate: document.getElementById("cardExpDate").value,
        billingZip: document.getElementById("billingZip").value,
        cardbtn: document.getElementById("cardbtn").value,
        fullname: document.getElementById("fullname").value,
        isActive: 1
      };

      try {
        const response = await fetch(`${API}/cards`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(newCard)
        });

        if (!response.ok) throw new Error("Card submission failed");

        const modal = bootstrap.Modal.getInstance(document.getElementById("addCardModal"));
        modal.hide();

        await refreshCards();
      } catch (err) {
        console.error("Error adding card:", err);
        alert("Failed to add card. Please try again.");
      }
    });

    function openUpdateModal(card) {
      document.getElementById("update-cardId").value = card.cardId;
      document.getElementById("update-cardType").value = card.cardType || "";
      document.getElementById("update-cardVendor").value = card.cardVendor || "";
      document.getElementById("update-cardLast4").value = card.cardLast4 || "";
      document.getElementById("update-cardExpDate").value = card.cardExpDate || "";
      document.getElementById("update-billingZip").value = card.billingZip || "";
      document.getElementById("update-cardbtn").value = card.cardbtn || "";
      document.getElementById("update-fullname").value = card.fullname || "";

      const modal = new bootstrap.Modal(document.getElementById("updateCardModal"));
      modal.show();
    }

    document.getElementById("update-card-form").addEventListener("submit", async function (e) {
      e.preventDefault();

      const cardId = document.getElementById("update-cardId").value;
      const updatedCard = {
        cardId: parseInt(cardId),
        uid: uid,
        cardType: document.getElementById("update-cardType").value,
        cardVendor: document.getElementById("update-cardVendor").value,
        cardLast4: document.getElementById("update-cardLast4").value,
        cardExpDate: document.getElementById("update-cardExpDate").value,
        billingZip: document.getElementById("update-billingZip").value,
        cardbtn: document.getElementById("update-cardbtn").value,
        fullname: document.getElementById("update-fullname").value,
        isActive: 1
      };

      try {
        const response = await fetch(`${API}/cards/${cardId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updatedCard)
        });

        if (!response.ok) throw new Error("Update failed");

        const modal = bootstrap.Modal.getInstance(document.getElementById("updateCardModal"));
        modal.hide();

        await refreshCards();
        alert("Card updated successfully!");
      } catch (err) {
        console.error("Error updating card:", err);
        alert("Failed to update card. Please try again.");
      }
    });
  </script>
</body>
</html>

