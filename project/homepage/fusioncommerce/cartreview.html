<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />

<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script> 
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script type="module" src="https://esm.run/@material/web/all.js"></script> 
<link rel="stylesheet" href="fusioncart.css" />

<script src="./js/cart.js"></script>
<script src="./js/products.js"></script>

<title>Your Cart</title>

<style>
  .highlight { background-color: #e0f3ff !important; }
  .selected { border: 2px solid #198754; }
  #userGreeting {
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
    text-align: center;
  }
  #banner {
    background-color: lightgrey;
    height: 60px;
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
  }
</style>
</head>

<body onload="checkpll(); checkUserStatus(); displayProfilePicture();">

<!-- NAVIGATION BAR -->
<div class="navbar">
  <div class="nav-left">
    <div class="dropdown">
      <button class="jsmenu"><img src="./images/greenmenu5.png"></button>
      <div class="dropdown-content">
        <a href="index.html">Home</a>
        <a href="login.html">Login</a>
        <a href="logout.html">Logout</a>
        <a href="welcome.html">Welcome</a>
        <a href="products.html">Products</a>
        <a href="mycart.html">My Cart</a>
        <a href="myprofile.html">My Profile</a>
        <a href="admin/products.html">Admin Products</a>
        <a href="admin/templates.html">Admin Templates</a>
      </div>
      <div class="logo">&nbsp;&nbsp;FusionCommerce â€“ Cart Review</div>
    </div>
  </div>

  <div class="nav-right">
    <img src="./images/blackcircle.png" id="profilephototarget" alt="User" onclick="window.location.href='myprofile.html'" />
    <span id="H3UserBanner"></span>
    <a href="login.html" id="loginBtn" class="btn secondary-btn">Login</a>
    <a href="logout.html" id="logoutBtn" class="btn secondary-btn">Logout</a>
    <a href="cartreview.html" id="cartBtn3"><img src="./images/cart4.png" width="40" height="40"></a>
  </div>
</div>

<div id="banner"><span id="userGreeting">Welcome Guest</span></div>

<div class="container py-5">
  <div id="cart-items" class="row g-4 mb-4"></div>

  <div class="text-center">
    <button id="checkout-btn" class="btn btn-primary btn-lg w-100">Checkout</button>
  </div>
</div>

<script>
$(document).ready(function () {
  const uid = localStorage.getItem("uid");
  const selectedCartIds = [];

  if (!uid) {
    $("#cart-items").html(`<div class="alert alert-danger">No user logged in.</div>`);
    return;
  }

  // Load carts from FusionCommerce API
  $.get("https://api242.onrender.com/cart", function (carts) {
    const userCarts = carts.filter(c => c.uid == uid && c.isCheckedOut != 1 && c.isCheckedOut != 2);

    if (userCarts.length === 0) {
      $("#cart-items").html(`<div class="alert alert-info">No active carts for user ${uid}.</div>`);
      return;
    }

    userCarts.forEach(cart => {
      const card = `
        <div class="col-md-6 col-lg-4">
          <div class="card h-100 shadow-sm" id="cart-${cart.cartId}">
            <div class="card-body d-flex flex-column">
              <p><strong>Cart ID:</strong> ${cart.cartId}</p>
              <p><strong>Description:</strong> ${cart.itemDescription}</p>
              <p><strong>Total Items:</strong> ${cart.totalcartitems}</p>
              <p><strong>Total Price:</strong> $${cart.transactiontotal}</p>
              <p><strong>Date Added:</strong> ${cart.dateAdded}</p>
              <p><strong>Checked Out:</strong> ${cart.isCheckedOut ? "Yes" : "No"}</p>

              <button class="btn btn-outline-success mt-auto w-100 select-btn" data-cartid="${cart.cartId}">
                Select for Payment
              </button>

              <button class="btn btn-outline-danger mt-2 w-100 cancel-btn" data-cartid="${cart.cartId}">
                Cancel Cart
              </button>
            </div>
          </div>
        </div>
      `;
      $("#cart-items").append(card);
    });

    // Select cart for payment
    $(document).on("click", ".select-btn", function () {
      const cartId = $(this).data("cartid").toString();
      const card = $(`#cart-${cartId}`);

      if (selectedCartIds.includes(cartId)) {
        selectedCartIds.splice(selectedCartIds.indexOf(cartId), 1);
        card.removeClass("selected");
        $(this).text("Select for Payment");
      } else {
        selectedCartIds.push(cartId);
        card.addClass("selected");
        $(this).text("Selected");
      }
    });

    // Checkout selected carts
    $("#checkout-btn").on("click", function () {
      if (selectedCartIds.length === 0) {
        alert("Please select at least one cart.");
        return;
      }

      const query = selectedCartIds.map(id => `cartId=${encodeURIComponent(id)}`).join("&");
      window.location.href = `payments8.html?${query}`;
    });

    // Cancel cart
    $(document).on("click", ".cancel-btn", function () {
      const cartId = $(this).data("cartid");

      if (!confirm("Are you sure you want to cancel this cart?")) return;

      $.ajax({
        url: `https://api242.onrender.com/cart/${cartId}`,
        type: "PUT",
        contentType: "application/json",
        data: JSON.stringify({ isCheckedOut: 2 }),
        success: function () {
          $(`#cart-${cartId}`).fadeOut(500, function () {
            $(this).remove();
          });
        },
        error: function (xhr, status, error) {
          alert("Failed to cancel cart.");
        }
      });
    });

  });
});
</script>

</body>

<footer class="footer">
  &copy; Cocky Consulting 2025.<br>
  All rights reserved.<br>
  <a href="sitemap.html" class="sitelink">SiteMap</a>
</footer>

</html>

