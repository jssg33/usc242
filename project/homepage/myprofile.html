<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Profile</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Your global green/black theme -->
    <link rel="stylesheet" href="css/global-theme.css">

    <style>
        .profile-card {
            border: 1px solid #00c853;
            background: #000;
            color: #00e676;
        }

        .profile-label {
            font-weight: 600;
            color: #00c853;
        }

        .profile-section-title {
            font-size: 1.2rem;
            margin-top: 20px;
            color: #00e676;
            border-bottom: 1px solid #00c853;
            padding-bottom: 4px;
        }
    </style>
</head>

<body class="p-4">

    <div class="container">

        <h2 class="mb-4" style="color:#00e676;">My Profile</h2>

        <!-- ACTION BAR -->
        <div class="action-bar mb-3">
            <button class="btn btn-green" id="editBtn">Edit Profile</button>
            <button class="btn btn-black" id="refreshBtn">Refresh</button>
        </div>

        <!-- PROFILE DISPLAY CARD -->
        <div class="card profile-card mb-4">
            <div class="card-body" id="profileDisplay">
                Loading profile...
            </div>
        </div>

        <!-- UPDATE PROFILE MODAL -->
        <div class="modal fade" id="updateModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">

                    <div class="modal-header table-header-green">
                        <h5 class="modal-title">Update Profile</h5>
                        <button class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">
                        <form id="updateForm" class="row g-3">

                            <!-- Basic Info -->
                            <div class="profile-section-title">Basic Information</div>

                            <div class="col-md-6">
                                <label class="profile-label">First Name</label>
                                <input class="form-control" name="firstname">
                            </div>

                            <div class="col-md-6">
                                <label class="profile-label">Last Name</label>
                                <input class="form-control" name="lastname">
                            </div>

                            <div class="col-md-6">
                                <label class="profile-label">Display Name</label>
                                <input class="form-control" name="displayname">
                            </div>

                            <div class="col-md-6">
                                <label class="profile-label">Username</label>
                                <input class="form-control" name="username">
                            </div>

                            <!-- Contact -->
                            <div class="profile-section-title">Contact</div>

                            <div class="col-md-6">
                                <label class="profile-label">Email</label>
                                <input class="form-control" name="email">
                            </div>

                            <div class="col-md-6">
                                <label class="profile-label">Phone</label>
                                <input class="form-control" name="phone">
                            </div>

                            <div class="col-md-6">
                                <label class="profile-label">Cell Phone</label>
                                <input class="form-control" name="cellphone">
                            </div>

                            <!-- Address -->
                            <div class="profile-section-title">Address</div>

                            <div class="col-md-6">
                                <label class="profile-label">Address 1</label>
                                <input class="form-control" name="address1">
                            </div>

                            <div class="col-md-6">
                                <label class="profile-label">Address 2</label>
                                <input class="form-control" name="address2">
                            </div>

                            <div class="col-md-4">
                                <label class="profile-label">City</label>
                                <input class="form-control" name="city">
                            </div>

                            <div class="col-md-4">
                                <label class="profile-label">State</label>
                                <input class="form-control" name="state">
                            </div>

                            <div class="col-md-4">
                                <label class="profile-label">Postal/Zip</label>
                                <input class="form-control" name="postalzip">
                            </div>

                            <div class="col-md-6">
                                <label class="profile-label">Country</label>
                                <input class="form-control" name="country">
                            </div>

                        </form>
                    </div>

                    <div class="modal-footer">
                        <button class="btn btn-black" data-bs-dismiss="modal">Cancel</button>
                        <button class="btn btn-green-dark" id="saveBtn">Save Changes</button>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_BASE = "https://api242.onrender.com";

        // Load UID from localStorage or use default Mongo-generated ID
        let uid = localStorage.getItem("uid");

        if (!uid) {
            uid = "6996382c2ee4254a4978d94c";
            localStorage.setItem("uid", uid);
        }

        // Load profile
        async function loadProfile() {
            const res = await fetch(`${API_BASE}/users/${uid}`);
            const data = await res.json();
            window.profileData = data;
            renderProfile(data);
        }

        // Render profile into card
        function renderProfile(p) {
            document.getElementById("profileDisplay").innerHTML = `
                <div class="profile-section-title">Basic Information</div>
                <p><span class="profile-label">Name:</span> ${p.fullname}</p>
                <p><span class="profile-label">Username:</span> ${p.username}</p>
                <p><span class="profile-label">Display Name:</span> ${p.displayname}</p>

                <div class="profile-section-title">Contact</div>
                <p><span class="profile-label">Email:</span> ${p.email}</p>
                <p><span class="profile-label">Phone:</span> ${p.phone}</p>
                <p><span class="profile-label">Cell:</span> ${p.cellphone}</p>

                <div class="profile-section-title">Address</div>
                <p><span class="profile-label">Address:</span> ${p.address1} ${p.address2}</p>
                <p><span class="profile-label">City:</span> ${p.city}</p>
                <p><span class="profile-label">State:</span> ${p.state}</p>
                <p><span class="profile-label">Postal:</span> ${p.postalzip}</p>
                <p><span class="profile-label">Country:</span> ${p.country}</p>
            `;
        }

        // Open modal with existing values
        document.getElementById("editBtn").onclick = () => {
            const form = document.getElementById("updateForm");
            Object.keys(window.profileData).forEach(key => {
                if (form[key]) form[key].value = window.profileData[key] || "";
            });

            new bootstrap.Modal(document.getElementById("updateModal")).show();
        };

        // Save changes
        document.getElementById("saveBtn").onclick = async () => {
            const form = document.getElementById("updateForm");
            const formData = Object.fromEntries(new FormData(form).entries());

            await fetch(`${API_BASE}/users/${uid}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(formData)
            });

            loadProfile();
            bootstrap.Modal.getInstance(document.getElementById("updateModal")).hide();
        };

        document.getElementById("refreshBtn").onclick = loadProfile;

        loadProfile();
    </script>

</body>
</html>
