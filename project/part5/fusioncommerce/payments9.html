<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <title>FusionCommerce – Payment Summary</title> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"> <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script> <link rel="stylesheet" href="./css/site.css" /> <link rel="stylesheet" href="./css/layout.css" /> <link rel="stylesheet" href="./css/greenville.css" /> </head> <body> <div class="container mt-4"> <h2>Payment Summary</h2> <div id="summary" class="mb-3"></div>

<div class="accordion" id="cartAccordion"></div>

<h3 class="mt-4">Select a Payment Method</h3>
<table class="table table-bordered">
  <thead>
    <tr>
      <th>Card Type</th>
      <th>Vendor</th>
      <th>Last 4</th>
      <th>Expiration</th>
      <th>Zip</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="cardTable"></tbody>
</table>

<div id="status" class="mt-3"></div>

</div>

<script> const API = "https://api242.onrender.com"; const params = new URLSearchParams(window.location.search); const cartIds = params.getAll("cartId"); const uid = localStorage.getItem("uid") || "1";

async function loadCartData() {
  let allItems = [];
  let cartSummaries = [];

  for (const cartId of cartIds) {
    const res = await fetch(`${API}/cartitems/cart/${cartId}`);
    const items = await res.json();

    const total = items.reduce((sum, i) => sum + (i.itemtotals || 0), 0);
    const isReservation = items.some(i => i.resStart && i.resEnd);

    cartSummaries.push({ cartId, total, isReservation, items });
    allItems.push(...items);
  }

  const grandTotal = cartSummaries.reduce((sum, c) => sum + c.total, 0);
  const totalItems = allItems.length;

  document.getElementById("summary").innerHTML = `
    <p><strong>Total Amount:</strong> $${grandTotal.toFixed(2)}</p>
    <p><strong>Total Carts:</strong> ${cartSummaries.length}</p>
    <p><strong>Total Items:</strong> ${totalItems}</p>
  `;

  renderAccordion(cartSummaries);
  loadCards(grandTotal, cartSummaries);
}

function renderAccordion(carts) {
  const acc = document.getElementById("cartAccordion");
  acc.innerHTML = "";

  carts.forEach((c, index) => {
    const type = c.isReservation ? "Reservation" : "Invoice";

    let rows = c.items.map(i => `
      <tr>
        <td>${i.itemDescription || i.itemType}</td>
        <td>${i.itemqty || 1}</td>
        <td>$${(i.itemtotals || 0).toFixed(2)}</td>
      </tr>
    `).join("");

    acc.innerHTML += `
      <div class="accordion-item">
        <h2 class="accordion-header" id="heading${index}">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}">
            Cart ${c.cartId} — $${c.total.toFixed(2)} — ${type}
          </button>
        </h2>
        <div id="collapse${index}" class="accordion-collapse collapse" data-bs-parent="#cartAccordion">
          <div class="accordion-body">
            <table class="table table-sm table-bordered">
              <thead>
                <tr><th>Item</th><th>Qty</th><th>Total</th></tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        </div>
      </div>
    `;
  });
}

async function loadCards(totalAmount, cartSummaries) {
  const res = await fetch(`${API}/cards?uid=${uid}`);
  const cards = await res.json();
  const tbody = document.getElementById("cardTable");
  tbody.innerHTML = "";

  cards.forEach(card => {
    tbody.innerHTML += `
      <tr>
        <td>${card.cardType}</td>
        <td>${card.cardVendor}</td>
        <td>${card.cardLast4}</td>
        <td>${card.cardExpDate}</td>
        <td>${card.billingZip}</td>
        <td>
          <button class="btn btn-primary btn-sm" onclick='pay(${JSON.stringify(card)}, ${totalAmount}, ${JSON.stringify(cartSummaries)})'>
            Pay $${totalAmount.toFixed(2)}
          </button>
        </td>
      </tr>
    `;
  });
}

function generateTransactionId() {
  const letters = Array.from({ length: 3 }, () => String.fromCharCode(65 + Math.floor(Math.random() * 26))).join("");
  const digits = Math.floor(100000000 + Math.random() * 900000000);
  return letters + digits;
}

async function pay(card, totalAmount, cartSummaries) {
  const transactionId = generateTransactionId();

  const payment = {
    paymentId: 0,
    cartid: null,
    bookingId: 0,
    paymentMethod: "Credit Card",
    cardType: card.cardType,
    cardLast4: card.cardLast4,
    cardExpDate: card.cardExpDate,
    amountPaid: totalAmount,
    amountRefunded: 0,
    paymentDate: new Date().toISOString(),
    transactionId,
    refundTransactionid: "",
    useridasstring: uid,
    transtype: "Payment",
    fullname: card.fullname || ""
  };

  await fetch(`${API}/payments`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payment)
  });

  let createdReservation = false;

  for (const cart of cartSummaries) {
    if (cart.isReservation) {
      createdReservation = true;
      const first = cart.items[0];

      const reservation = {
        bookingId: 0,
        uid,
        totalAmount: cart.total,
        transactionId,
        cartid: cart.cartId,
        reservationtype: "Reservation",
        reservationstatus: "Completed",
        resStart: first.resStart,
        resEnd: first.resEnd,
        createdAt: new Date().toISOString()
      };

      await fetch(`${API}/reservations`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(reservation)
      });
    } else {
      const invoice = {
        invoiceId: 0,
        customerId: uid,
        subtotal: cart.total,
        taxTotal: 0,
        discountTotal: 0,
        grandTotal: cart.total,
        invoiceDate: new Date().toISOString(),
        dueDate: new Date().toISOString(),
        status: "paid",
        cartId: cart.cartId,
        transactionId
      };

      await fetch(`${API}/invoices`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(invoice)
      });
    }
  }

  if (createdReservation) window.location.href = "mypurchases5.html";
  else window.location.href = "myinvoices.html";
}

loadCartData();

</script> </body> </html>